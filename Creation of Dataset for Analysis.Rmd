---
title: "Pre-Analytic Cleaning+Imputation"
output: html_document
date: "2025-06-17"
---

To date this is the capabilities of this code
      Main parent group diagnosis
      Dim anxiety for young participant. 
      Looks for diagnosis
      Creates lifetime diagnosis based on current
      Creates onset of disorder variable
      Has some hospital information on diagnosis

##Need to do
Create value for different parent diagnoses
Need lifetime baseline diagnosis of disorders

Make dim and antecedent variables
  dimdep dimanx scaredytot dimafflaby dimafflab dimirrit dimpsych dimbs dimsleep
  antanx antafflab antpsych antbs antsleep antcog antdep antno 


##Things of Note
Maybe some weird diagnosis variables? Like SAD.
Observations always have one observation that is NA?

## Library
```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(haven); library(dplyr); library(tidyr); library(readr); library(readxl); library(data.table); library(stringr); library(purrr)  # Data manipulation & import
library(lme4); library(lmerTest); library(coxme); library(survival); library(broom); library(MuMIn); library(lsmeans)  # Modeling & statistics
library(pander); library(apaTables); library(flextable); library(officer); library(webshot2)  # Tables & reporting
library(ggplot2)  # Plotting
library(fuzzyjoin)  # Joins
library(survminer)
library(plotly)
```

## Load CSV
```{r}
setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
# setwd("C:/Users/zachh/Documents/Code/git/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data/ESCAP") # Tupper Windows Comp
# setwd("C:/Users/zacha/Documents/forbow/code/git") # Home Computer

FOR <- read.csv("FORBOWMasterDatabase.csv", header=TRUE, fileEncoding="latin1")
```



##Parent Diagnosis and Family Risk
```{r}
FOR$fid <- substr(FOR$subject_id, 5, 7)
FOR$iid <- substr(FOR$subject_id, 8, 11)
FOR_P <- FOR %>%
  filter(str_detect(subject_id, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))


FOR_P <- FOR_P %>%
  mutate(group = case_when(
    mdx == 4 ~ 1,
    mdx %in% c(2, 3) ~ 2,
    mdx == 1 ~ 3,
    mdx == 0 ~ 0,
    fdx == 4 ~ 1, 
    fdx %in% c(2,3) ~ 2,
    fdx == 1 ~ 3,
    fdx == 0 ~ 0,
    TRUE ~ NA_real_
  ))

FOR_P <- FOR_P %>%
  group_by(subject_id) %>%
  mutate(
    group = {
      g <- group[is.na(time_point)]
      if (length(g) == 0 || is.na(g[1])) 0 else g[1]
    }
  ) %>%
  ungroup()


#Pure exploratory to see what kind of group combos we have 
fid_groups <- FOR_P %>%
  distinct(fid, group) %>%
  group_by(fid) %>%
  summarise(groups = list(sort(unique(group))), .groups = "drop")
fid_groups <- fid_groups %>%
  mutate(group_combo = sapply(groups, paste, collapse = "-"))
combo_summary <- fid_groups %>%
  count(group_combo) %>%
  arrange(desc(n))

print(combo_summary)
```

## Dimension Anxiety Creation
```{r}
Scared_C_Variables <- paste0("scared_child_", 1:41)
Scared_P_Variables <- paste0("scared_parent_", 1:41)
FOR <- FOR %>%
  # Recode 9s to NA
  mutate(across(all_of(Scared_C_Variables), ~na_if(.x, 9))) %>%
  mutate(across(all_of(Scared_P_Variables), ~na_if(.x, 9))) %>%
  
  # Compute total scores
  mutate(
    Scared_C_Total = rowSums(across(all_of(Scared_C_Variables)), na.rm = TRUE),
    Scared_P_Total = rowSums(across(all_of(Scared_P_Variables)), na.rm = TRUE)
  ) %>%
  
  # Standardize total scores
  mutate(
    Scared_C_Total_z = as.numeric(scale(Scared_C_Total)),
    Scared_P_Total_z = as.numeric(scale(Scared_P_Total))
  )

Scas_C_Variables <- paste0("scas_child_", 1:44)
Scas_P_Variables <- paste0("scas_parent_", 1:38)

remove_indices <- c(11, 17, 26, 31, 38, 43)
Scas_C_Variables <- Scas_C_Variables[-remove_indices]


FOR <- FOR %>%
  # Recode 9s to NA
  mutate(across(all_of(Scas_C_Variables), ~na_if(.x, 9))) %>%
  mutate(across(all_of(Scas_P_Variables), ~na_if(.x, 9))) %>%
  
  # Compute total scores
  mutate(
    Scas_C_Total = rowSums(across(all_of(Scas_C_Variables)), na.rm = TRUE),
    Scas_P_Total = rowSums(across(all_of(Scas_P_Variables)), na.rm = TRUE)
  ) %>%
  
  # Standardize total scores
  mutate(
    Scas_C_z = as.numeric(scale(Scas_C_Total)),
    Scas_P_z = as.numeric(scale(Scas_P_Total))
  )

FOR <- FOR %>%
  # SCAS dimanx
  mutate(dimanx = rowMeans(across(c(Scas_C_z, Scas_P_z, Scared_C_Total_z, Scared_P_Total_z)), na.rm = TRUE)) 

FOR <- FOR %>%
  group_by(subject_id) %>%
  mutate(dob = dob[which(is.na(time_point))][1]) %>%
  ungroup()
FOR <- FOR %>%
  group_by(subject_id) %>%
  mutate(sex = sex[which(is.na(time_point))][1]) %>%
  ungroup()
FOR <- FOR %>%
  mutate(sex = case_when(
    sex == 1 ~ 0,
    sex == 2 ~ 1
  ))
FOR <- FOR %>%
  group_by(subject_id) %>%
  filter(all(!is.na(dob) & dob != "")) %>%  # Keep only groups where *all* dob are not missing or empty
  ungroup()
invalid_si <- c("9999999888", "9999999998")
FOR <- FOR %>%
  filter(!subject_id %in% invalid_si)

FOR$assessment_date <- as.Date(FOR$assessment_date)
FOR$dob <- as.Date(FOR$dob)
FOR$age_days <- FOR$assessment_date - FOR$dob
FOR$age <- as.numeric(FOR$age_days) / 365.25
```


##Current Diagnosis
```{r}
### List of FORBOW Diagnoses


KSADS_ALL <- c('MDD', 'DEP', 'Dysthy', 'BP', 'BPI', 'BPII', 'MOOD',
               'Psychosis', 'iPsychosis', 'SCZ', 'SchAff',
               'SUD', 'Alc', 'Can', 'Dependence',
               'Anx', 'Panic', 'OthAnx', 'GAD', 'SocialP', 'PTSD', 'Agora', 'SpecificP', 'OCD', 'SAD',
               'ADHD', 'ODD', 'Conduct', 'Disrupt',
               'ED', 'EDNOS', 'Anor', 'Bulims',
               'Autism', 'ASD', 'Tic', 'Touret',
               'LD', 'LDs', 'LDg',
               'DMDD', 'Sleep',
               'Borderline', 'Antisocial', 'PersonalityDisord')


##ccMDD = 0
##ccDEP = 0
##ccPsychosis = 0
##cciPsychosis = 0
##ccSCHZ = 0
##ccSchAff = 0 
##ccBPD = 0
##ccBPDI = 0
##ccBPDII = 0
##ccBorderline = 0
##ccAntisocial = 0
##ccANX = 0
##ccPanic = 0
##ccOthAnx = 0
##ccGAD = 0
##ccSocialP = 0 
##ccAgora = 0
##ccPTSD = 0 
##ccOCD = 0
##ccSAD = 0
##ccSpecificP = 0
##ccSUD = 0
##ccCan = 0
##ccAlc = 0
##ccDependence = 0
##ccADHD = 0
##ccODD = 0
##ccConduct = 0
##ccDisrupt = 0
##ccED = 0
##ccAnor = 0
##ccBulim = 0
##ccEDNOS = 0
##ccAutism = 0
##ccASD = 0
##ccTic = 0
##ccTouret = 0
##ccLD = 0
##ccLDs = 0
##ccLDg = 0
##ccSleep
##ccDMDD
##ccDysthy = 0

###Varaibles we have but are unused?
#ccPBPD = 0
#ccPDD = 0
#ccAdjAnx = 0



##Clinical Diagnosis from Consesus
Diagnosis_vars <- paste0("cd_c_dx_", 1:10)

#Depression
FOR$ccMDD <- 0
FOR$ccDEP <- 0 
FOR$ccDysthy <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  text_col <- paste0("cd_c_dx_other_", i)
  rows_to_update <- FOR[[dx_col]] == 1 & FOR[[conf_col]] != 0
  FOR$ccMDD[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(1,2,3) & FOR[[conf_col]] != 0
  FOR$ccDEP[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("depress", "Depress", "Major Depress", "major depress") & FOR[[conf_col]] != 0
  FOR$ccDEP[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(2) & FOR[[conf_col]] != 0
  FOR$ccDysthy[rows_to_update] <- 1
}

#Mania
FOR$ccBP <- 0
FOR$ccBPI <- 0
FOR$ccBPII <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  text_col <- paste0("cd_c_dx_other_", i)
  rows_to_update <- FOR[[dx_col]] %in% c(4, 5,6,7) & FOR[[conf_col]] != 0
  FOR$ccBP[rows_to_update] <- 1
  rows_to_update <- FOR[[dx_col]] %in% c(4) & FOR[[conf_col]] != 0
  FOR$ccBPI[rows_to_update] <- 1
  rows_to_update <- FOR[[dx_col]] %in% c(5) & FOR[[conf_col]] != 0
  FOR$ccBPI[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("Mania", "mania", "Bipolar", "bipolar") & FOR[[conf_col]] != 0
  FOR$ccBP[rows_to_update] <- 1
}
table(FOR$ccBP)
table(FOR$ccBPI)
table(FOR$ccBPII)


##Psychosis
FOR$ccPsychosis <- 0
FOR$cciPsychosis <- 0
FOR$ccSCZ <- 0
FOR$ccSchAff <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  rows_to_update <- FOR[[dx_col]] %in% c(8,9,10,11,12,13,14) & FOR[[conf_col]] != 0 
  FOR$ccPsychosis[rows_to_update] <- 1
  rows_to_update <- FOR[[dx_col]] %in% c(8) & FOR[[conf_col]] != 0 
  FOR$ccSCZ[rows_to_update] <- 1
  rows_to_update <- FOR[[dx_col]] %in% c(9) & FOR[[conf_col]] != 0 
  FOR$ccSchAff[rows_to_update] <- 1
}

#Personality
FOR$ccBorderline <- 0
FOR$ccAntisocial <- 0
FOR$ccPersonalityDisord <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  text_col <- paste0("cd_c_dx_other_", i)
  rows_to_update <- FOR[[dx_col]] %in% c(25) & FOR[[conf_col]] != 0 
  FOR$ccBorderline[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("orderline") & FOR[[conf_col]] != 0
  FOR$ccBorderline[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(26) & FOR[[conf_col]] != 0 
  FOR$ccAntisocial[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("ntisocial") & FOR[[conf_col]] != 0
  FOR$ccAntisocial[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(70,71,72,73,74,75,76,77,78,79,80) & FOR[[conf_col]] != 0
  FOR$ccPersonalityDisord[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("personality", "Personality", "antisocial", "Antisocial", "orderline") &FOR[[conf_col]] != 0
  FOR$ccPersonalityDisord[rows_to_update] <- 1
}

#Substance Use
FOR$ccAlc <- 0
FOR$ccCan <- 0
FOR$ccSUD <- 0
FOR$ccDependence <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  rows_to_update <- FOR[[dx_col]] %in% c(38,39) & FOR[[conf_col]] != 0 
  FOR$ccAlc[rows_to_update] <- 1
  rows_to_update <- FOR[[dx_col]] %in% c(40,41) & FOR[[conf_col]] != 0 
  FOR$ccCan[rows_to_update] <- 1
  rows_to_update <- FOR[[dx_col]] %in% c(38,39,40,41,42,43) & FOR[[conf_col]] != 0 
  FOR$ccSUD[rows_to_update] <- 1
  rows_to_update <- FOR[[dx_col]] %in% c(39,41,43) & FOR[[conf_col]] != 0 
  FOR$ccDependence[rows_to_update] <- 1
}

#Anxiety Disorders
FOR$ccAnx <- 0
FOR$ccSAD <- 0  #Why is SAD 15 and why is anxiety within SAD?
FOR$ccSpecificP <- 0
FOR$ccSocialP <- 0 
FOR$ccAgora <- 0
FOR$ccPanic <- 0
FOR$ccGAD <- 0
FOR$ccOCD <- 0
FOR$ccPTSD <- 0
FOR$ccOthAnx <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  text_col <- paste0("cd_c_dx_other_", i)
  
  rows_to_update <- FOR[[dx_col]] %in% c(15,16,17,18,19,20,21,22,24) & FOR[[conf_col]] != 0    #Anxiety Disorders
  FOR$ccAnx[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("nxiety", "GAD", "Mutism", "mutism") & FOR[[conf_col]] != 0    #Anxiety disorders
  FOR$ccAnx[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(15) & FOR[[conf_col]] != 0    #SAD?
  FOR$ccSAD[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(16) & FOR[[conf_col]] != 0   #Specific P
  FOR$ccSpecificP[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(17) & FOR[[conf_col]] != 0   #Social P
  FOR$ccSocialP[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("Social") & FOR[[conf_col]] != 0 #Social P
  FOR$ccSocialP[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(18) & FOR[[conf_col]] != 0        #AGORA
  FOR$ccAgora[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(19) & FOR[[conf_col]] != 0       #Panic
  FOR$ccPanic[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(20) & FOR[[conf_col]] != 0       #GAD
  FOR$ccGAD[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("GAD") & FOR[[conf_col]] != 0 #GAD
  FOR$ccGAD[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(21) & FOR[[conf_col]] != 0       #OCD
  FOR$ccOCD[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(22) & FOR[[conf_col]] != 0       #PTSD
  FOR$ccPTSD[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(24) & FOR[[conf_col]] != 0       #OthAnx
  FOR$ccOthAnx[rows_to_update] <- 1
}

#Eating Disorder
FOR$ccAnor <- 0
FOR$ccBulims <- 0
FOR$ccEDNOS <- 0
FOR$ccED <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  text_col <- paste0("cd_c_dx_other_", i)
  
  rows_to_update <- FOR[[dx_col]] %in% c(28) & FOR[[conf_col]] != 0 
  FOR$ccAnor[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(29) & FOR[[conf_col]] != 0 
  FOR$ccBulims[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(30) & FOR[[conf_col]] != 0 
  FOR$ccEDNOS[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(28,29,30) & FOR[[conf_col]] != 0 
  FOR$ccED[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("Eating","eating","Pica", "pica") & FOR[[conf_col]] != 0 
  FOR$ccED[rows_to_update] <- 1
}

##Development
FOR$ccADHD <- 0
FOR$ccODD <- 0
FOR$ccConduct <- 0
FOR$ccDisrupt <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  text_col <- paste0("cd_c_dx_other_", i)
  
  rows_to_update <- FOR[[dx_col]] %in% c(31,32,33) & FOR[[conf_col]] != 0    #ADHD
  FOR$ccADHD[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("ADHD") & FOR[[conf_col]] != 0 
  FOR$ccADHD[rows_to_update] <- 1
    
  rows_to_update <- FOR[[dx_col]] %in% c(34) & FOR[[conf_col]] != 0         #ODD
  FOR$ccODD[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(35) & FOR[[conf_col]] != 0        #Conduct
  FOR$ccConduct[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(34,35) & FOR[[conf_col]] != 0        #Disruptive Disorder
  FOR$ccDisrupt[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("isruptive") & FOR[[conf_col]] != 0 
  FOR$ccDisrupt[rows_to_update] <- 1
}

#Neuro
FOR$ccTic <- 0
FOR$ccTouret <- 0
FOR$ccAutism <- 0
FOR$ccASD <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  text_col <- paste0("cd_c_dx_other_", i)
  
  rows_to_update <- FOR[[dx_col]] %in% c(36,37) & FOR[[conf_col]] != 0    #TIC
  FOR$ccTic[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("Tic", "tic", "ouret") & FOR[[conf_col]] != 0 
  FOR$ccTic[rows_to_update] <- 1
    
  rows_to_update <- FOR[[dx_col]] %in% c(36) & FOR[[conf_col]] != 0         #Touret
  FOR$ccTouret[rows_to_update] <- 1
  rows_to_update <- FOR[[text_col]] %in% c("ouret") & FOR[[conf_col]] != 0 
  FOR$ccTouret[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(44) & FOR[[conf_col]] != 0        #Autism
  FOR$ccAutism[rows_to_update] <- 1
  
  rows_to_update <- FOR[[dx_col]] %in% c(44,45, 46) & FOR[[conf_col]] != 0        #Autism Spectrum
  FOR$ccASD[rows_to_update] <- 1
}

#Learning Disabilities
FOR$ccLD <- 0
FOR$ccLDs <- 0
FOR$ccLDg <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  text_col <- paste0("cd_c_dx_other_", i)
  
  rows_to_update <- FOR[[text_col]] %in% c("LD", "Learning", "learning", "Intellectual", "intellectual", "Fragile", "Dyslexia", "dyslexia", "Dysgraphia", "dysgraphia", "Retardation", "retardation", "Communication", "disability")
  FOR$ccLD[rows_to_update] <- 1
    
  rows_to_update <- FOR[[text_col]] %in% c("Spelling", "spelling", "Reading", "reading", "Non-Verbal", "Processing Speed", "Phonological", "Dyslexia", "dyslexia", "dysgraphia", "Dysgraphia", "Communication") 
  FOR$ccLDs[rows_to_update] <- 1
  
  rows_to_update <- FOR[[text_col]] %in% c("Intellectual", "intellectual", "Retardation", "retardation") 
  FOR$ccLDs[rows_to_update] <- 1
}

#Sleep
FOR$ccSleep <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  text_col <- paste0("cd_c_dx_other_", i)
  rows_to_update <- FOR[[text_col]] %in% c("insomnia", "sleep", "somnia")
  FOR$ccSleep[rows_to_update] <- 1
}


#Disruptive Mood
FOR$ccDMDD <- 0
for (i in 1:10) {
  dx_col <- paste0("cd_c_dx_", i)
  conf_col <- paste0("cd_c_confirmed_", i)
  text_col <- paste0("cd_c_dx_other_", i)
  rows_to_update <- FOR[[text_col]] %in% c("DMDD")
  FOR$ccDMDD[rows_to_update] <- 1
}

FOR <- FOR %>%
  mutate(ccMOOD = ifelse(ccBP == 1 | ccDEP == 1 | ccMDD == 1, 1, 0))



for (i in KSADS_ALL) {
  dx_col <- paste0("cc", i)
  
  for (x in 1:16) {
    nxt_col <- paste0(i, "NxtYr", x)
    prv_col <- paste0(i, "PrvYr", x)
    
    FOR <- FOR %>%
      group_by(subject_id) %>%
      arrange(desc(time_point)) %>%
      mutate(
        !!nxt_col := lag(.data[[dx_col]], x),
        !!prv_col := lead(.data[[dx_col]], x)
      ) %>%
      ungroup()
  }
}


for (i in KSADS_ALL) {
  FOR[[paste0("FutureDiag", i)]] <- 0
  FOR[[paste0("PastDiag", i)]] <- 0
}

# Step 2: Loop through each diagnosis and lag/lead year
for (i in KSADS_ALL) {
  for (x in 1:16) {
    dx_Nxt_col <- paste0(i, 'NxtYr', x)
    dx_Prv_col <- paste0(i, 'PrvYr', x)
    future_col <- paste0('FutureDiag', i)
    past_col <- paste0('PastDiag', i)

    # If the future column exists and has value 1
    if (dx_Nxt_col %in% names(FOR)) {
      idx <- which(FOR[[dx_Nxt_col]] == 1)
      FOR[[future_col]][idx] <- 1
    }

    # If the past column exists and has value 1
    if (dx_Prv_col %in% names(FOR)) {
      idx <- which(FOR[[dx_Prv_col]] == 1)
      FOR[[past_col]][idx] <- 1
    }
  }
}

```


##Lifetime Diagnosis
```{r}
###Lifetime Diagnosis
#List of lifetime diagnosis  missing?

#clPBPD, clPDD, clAdjAnx, clPrim

##Mood

for (dx in KSADS_ALL) {
  cc_var <- paste0("cc", dx)
  cl_var <- paste0("cl", dx)

  FOR <- FOR %>%
    group_by(subject_id) %>%
    arrange(assessment_date, .by_group = TRUE) %>%
    mutate(!!cl_var := as.integer(cumsum(.data[[cc_var]] == 1) > 0)) %>%
    ungroup()
}
table(FOR$clMDD)
```


##Onset
```{r}
KSADS <- c('MDD', 'BP', 'BPI', 'BPII', 'MOOD', 'Psychosis', 'SCZ', 'SchAff', 'iPsychosis', 'SUD', 'Alc', 'Can', 'Dependence', 'Anx', 'Panic', 'OthAnx', 'GAD', 'SocialP', 'PTSD', 'Agora', 'OCD', 'SAD', 'ADHD', 'ODD', 'Conduct', 'Disrupt', 'ED', 'EDNOS', 'Anor', 'Bulims', 'Autism', 'ASD', 'Tic', 'Touret', 'LD', 'LDs', 'LDg', 'DMDD', 'Sleep', 'Borderline', 'Antisocial', 'PersonalityDisord')

for (dx in KSADS) {
  cc_var <- paste0("cc", dx)
  o_var <- paste0("o", dx)

  FOR <- FOR %>%
    group_by(subject_id) %>%
    arrange(assessment_date, .by_group = TRUE) %>%
    mutate(!!o_var := ifelse(row_number() == which(.data[[cc_var]] == 1)[1] & .data[[cc_var]] == 1, 1, 0)) %>%
    ungroup()
}
```

##Hospital Diagnosis
```{r}
###  Diagnosis from IWK, notes, conseus

FOR$iid <- as.numeric(FOR$iid)
#Originally ccCan was cannabis, should this be different?
FOR <- FOR %>%
  mutate(
    ccSUD = ifelse(iid == 443 & time_point %in% c(2, 3), 1, ccSUD),
    ccCan = ifelse((iid == 443 & time_point == 3) |
                      (iid == 321 & time_point %in% c(3, 4, 5)), 1, ccCan),
    ccPsychosis = ifelse((iid == 443 & time_point == 3) |
                         (iid == 281 & time_point == 5), 1, ccPsychosis),
    clSUD = ifelse((iid == 321 & time_point == 5) |
                   (iid == 443 & time_point %in% c(2, 3)), 1, clSUD),
    ccBorderline = ifelse(iid == 321 & time_point == 5, 1, ccBorderline),
    clBorderline = ifelse(iid == 321 & time_point == 5, 1, clBorderline),
    ccAntisocial = ifelse(iid == 321 & time_point == 5, 1, ccAntisocial),
    clAntisocial = ifelse(iid == 321 & time_point == 5, 1, clAntisocial),
    clPsychosis = ifelse((iid == 443 & time_point == 3) |
                         (iid == 281 & time_point > 4.5), 1, clPsychosis),
    oSCZ = ifelse((iid == 443 & time_point == 3) |
                   (iid == 281 & time_point == 5), 1, oSCZ)
  )






# ** additional information from IWK, notes, consensusdg
# ** iid 443, transient psychosis, schizoprhenia spectrum disorder, on aripiprazole
# replace ccSUD = 1 if iid==443 & time==2
# replace ccSUD = 1 if iid==443 & time==3
# replace cannabis = 1 if iid==443 & time==3
# replace ccPsychosis=1 if iid==443 & time==3
# replace cannabis = 1 if iid==321 & time==3
# replace cannabis = 1 if iid==321 & time==4
# replace cannabis = 1 if iid==321 & time==5
# replace ccSUD = 1 if iid==321 & time==5
# replace clSUD = 1 if iid==321 & time==5
# replace ccBorderline = 1 if iid==321 & time==5
# replace clBorderline = 1 if iid==321 & time==5
# replace ccAntisocial = 1 if iid==321 & time==5
# replace clAntisocial = 1 if iid==321 & time==5
# 
# replace clSUD = 1 if iid==443 & time==2
# replace clSUD = 1 if iid==443 & time==3
# replace clPsychosis=1 if iid==443 & time==3
# replace oSCHZ=1 if iid==443 & time==3
# replace ccPsychosis=1 if iid==281 & time==5
# replace clPsychosis=1 if iid==281 & time>4.5
# replace oSCHZ=1 if iid==281 & time==5


##Consesus Lifetime Diagnosis
```


```{R}
FOR$round_age <- round(FOR$age)

table(FOR$round_age, FOR$ccMDD)

fid_group_list <- FOR_P %>%
  group_by(fid) %>%
  summarise(group = max(group, na.rm = TRUE), .groups = "drop")
# Step 2: Join back to the full FOR dataset
FOR <- FOR %>%
  left_join(fid_group_list, by = "fid")
table(FOR$group)
```


# Create my analytic now.
```{r}
setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
# setwd("C:/Users/zachh/Documents/Code/git/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data/ESCAP") # Tupper Windows Comp
# setwd("C:/Users/zacha/Documents/forbow/code/git") # Home Computer

write.csv(FOR, file = "analytic-zach.csv", row.names = FALSE)
```


```{r}



```






```{R}
look <- FOR %>% select(subject_id, 'time_point')

FOR <- FOR %>% filter(time_point < 97)

FOR$assessment_date[FOR$assessment_date == ""] <- NA  # Replace "" with NA
FOR$assessment_date <- as.Date(FOR$assessment_date) 



FOR$subject_id <- as.factor(FOR$subject_id)
FOR$assessment_date <- as.Date(FOR$assessment_date)

FOR <- FOR %>%
  arrange(subject_id) %>%
  mutate(
    group_index = (as.integer(subject_id) - 1) %/% 50 + 1,
    group_label = paste0("Group ", group_index)
  )

group_labels <- unique(FOR$group_label)

plot_list <- lapply(group_labels, function(grp) {
  df_grp <- FOR %>% filter(group_label == grp)
  
  p <- ggplot(df_grp, aes(x = assessment_date, y = time_point, group = subject_id, color = subject_id)) +
    geom_line() +
    geom_point(size = 2) +
    theme_minimal() +
    labs(
      title = paste("Participant Timepoints -", grp),
      x = "Assessment Date",
      y = "Timepoint",
      color = "Subject ID"
    )
  
  ggplotly(p)
})

plot_list[[15]]
```



##TOC
```{R}
# 1 "Major Depressive Disorder" ///
# 2 "Dysthymic Disorder" ///
# 3 "Mood Disorder NOS" ///
# 4 "Bipolar disorder I" ///
# 5 "Bipolar disorder II" ///
# 6 "Cyclothymic Disorder" ///
# 7 "Bipolar disorder NOS" ///
# 8 "Schizophrenia" ///
# 9 "Schizoaffective" ///
# 10 "Schizophreniform" ///
# 11 "Delusional Disorder" ///
# 12 "Brief Psychotic Disorder" ///
# 13 "Psychotic Disorder NOS" ///
# 14 "Psychotic disorder substance induced" ///
# 15 "Separation Anxiety" ///
# 16 "Specific Phobia" ///
# 17 "Social Phobia" ///
# 18 "Agoraphobia" ///
# 19 "Panic disorder" ///
# 20 "GAD" ///
# 21 "OCD" ///
# 22 "PTSD" ///
# 23 "Acute Stress" ///
# 24 "Anxiety Disorder NOS" ///
# 25 "Panic Attack" ///
# 26 "Enuresis" ///
# 27 "Encopresis" ///
# 28 "Anorexia Nervosa" ///
# 29 "Bulimia" ///
# 30 "Eating Disorder NOS" ///
# 31 "ADHD Combined" ///
# 32 "ADHD Inattentive" ///
# 33 "ADHD Hyperactive-Imp" ///
# 34 "ODD" ///
# 35 "Conduct Disorder" ///
# 36 "Tic Disorder Chronic" ///
# 37 "Tic Disorder Transient" ///
# 38 "Alcohol Abuse" ///
# 39 "Alcohol Dependence" ///
# 40 "Cannabis abuse" ///
# 41 "Cannabis dependence" ///
# 42 "Substance Abuse" ///
# 43 "Substance Dependence" ///
# 44 "Autistic Disorder" ///
# 45 "Aspergers Disorder" ///
# 46 "PDD NOS" ///
# 98 "Other Disorder" ///
# 99 "No response"


```


